<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onebar - Game</title>
    <link rel="stylesheet" href="/css/theme.css">
    <style>
        #hand img {
            width: 100px;
            margin: 5px;
            cursor: pointer;
        }
        #table img {
            width: 120px;
            margin: 5px;
        }
        #playerList {
            margin-bottom: 10px;
        }
        .current {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Game</h1>

    <div id="playerList"></div>
    <div id="status"></div>

    <h3>Your Hand</h3>
    <div id="hand"></div>

    <h3>Table</h3>
    <div id="table"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/theme.js"></script>
</body>
<script>
    const socket = io();

    const playerName = prompt('Enter your name', 'Player') || 'Player';

    socket.emit('joinGame', { playerName, gameId: 'default' });

    socket.on('joined', ({ playerId, gameId }) => {
        console.log('joined', playerId, gameId);
        document.getElementById('status').innerText = `Joined game ${gameId} as ${playerName}`;
    });

    socket.on('playerList', (players) => {
        const el = document.getElementById('playerList');
        el.innerHTML = 'Players:' + players.map(p => `<span id="p_${p.id}">${p.name}</span>`).join(' | ');
    });
    socket.on('deal', (hand) => {
        renderHand(hand);
        console.log('received deal', hand);
    });
    
    socket.on('gameStarted', ({currentPlayerId, players}) => {
        updateCurrentPlayer(currentPlayerId);
    });

    socket.on('turnChanged', ({ currentPlayerId }) => {
        updateCurrentPlayer(currentPlayerId);
    });

    socket.on('cardPlayed', ({ playerId, playerName, card }) => {
        addCardToTable(card, playerId, playerName);
        removeCardFromHand(card.id);
    });

    socket.on('invalidMove', ({ reason }) => {
        alert('Invalid move: ' + reason);
    });

    function renderHand(hand) {
      const container = document.getElementById('hand');
      container.innerHTML = '';
      hand.forEach(card => {
        const img = document.createElement('img');
        img.src = card.img;
        img.alt = card.name || card.value;
        img.dataset.cardId = card.id;
        img.title = `${card.name} (value ${card.value})`;
        img.addEventListener('click', () => {
          // play the card
          if (card.color === 'wild') {
            const chosen = prompt('Choose a color: red, blue, green, yellow');
            const allowed = ['red', 'blue', 'green', 'yellow'];
            const chosenColor = (chosen && allowed.includes(chosen.toLowerCase())) ? chosen.toLowerCase() : 'red';
            socket.emit('playCard', { gameId: 'default', cardId: card.id, chosenColor });
          } else {
            socket.emit('playCard', { gameId: 'default', cardId: card.id });
          }
        });
        container.appendChild(img);
      });
    }

    function addCardToTable(card, playerId, playerName) {
      const table = document.getElementById('table');
      const wrapper = document.createElement('div');
      const displayName = playerName || (document.getElementById('p_' + playerId)?.textContent) || playerId;
      wrapper.innerHTML = `<div>${displayName}</div>`;
      const img = document.createElement('img');
      img.src = card.img;
      img.alt = card.name;
      wrapper.appendChild(img);
      if (card.chosenColor) {
        const badge = document.createElement('div');
        badge.innerText = `Color: ${card.chosenColor}`;
        wrapper.appendChild(badge);
      }
      table.appendChild(wrapper);
    }

    function removeCardFromHand(cardId) {
      const imgs = document.querySelectorAll('#hand img');
      imgs.forEach(img => {
        if (img.dataset.cardId === cardId) img.remove();
      });
    }

     function updateCurrentPlayer(currentId, playerName) {
      const status = document.getElementById('status');
      const displayName = playerName || (document.getElementById('p_' + currentId)?.textContent) || currentId;
      status.innerText = `Current turn: ${displayName || currentId}`;
      // Highlight the player's name in playerList here
    }

    // For testing: a button to start the game (only visible to the first player normally)
    const startBtn = document.createElement('button');
    startBtn.innerText = 'Start Game';
    startBtn.addEventListener('click', () => socket.emit('startGame', { gameId: 'default', handSize: 7 }));
    document.body.appendChild(startBtn);
    //what do I need to do on the game page to make the starting top card show up on the table, also make it so instead of just keep adding to a list it just replaces the card that was there before. Also can you give me an example of what the file name should look like for the wilds and wild draw 4's
</script>
</html>
