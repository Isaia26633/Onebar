<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onebar - Game</title>
    <link rel="stylesheet" href="/css/theme.css">
    <style>
        #hand img {
            width: 100px;
            margin: 5px;
            cursor: pointer;
        }
        #table img {
            width: 120px;
            margin: 5px;
        }
        #playerList {
            margin-bottom: 10px;
        }
        .current {
            font-weight: bold;
        }
             #tableArea {
            display: flex;
            align-items: center;
            gap: 20px; /* space between draw pile and discard */
            margin-top: 8px;
        }
        #drawPile {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #table {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Game</h1>

    <div id="playerList"></div>
    <div id="status"></div>

    <h3>Your Hand</h3>
    <div id="hand"></div>

    <h3>Table</h3>
     <div id="tableArea"></div>
      <div id="drawPilePlaceholder"></div>
      
    <div id="table"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/theme.js"></script>
</body>
<script>
    const socket = io();

    const playerName = prompt('Enter your name', 'Player') || 'Player';

    socket.emit('joinGame', { playerName, gameId: 'default' });

    socket.on('joined', ({ playerId, gameId }) => {
        console.log('joined', playerId, gameId);
        document.getElementById('status').innerText = `Joined game ${gameId} as ${playerName}`;
    });

    socket.on('playerList', (players) => {
        const el = document.getElementById('playerList');
        el.innerHTML = 'Players:' + players.map(p => `<span id="p_${p.id}">${p.name}</span>`).join(' | ');
    });
    socket.on('deal', (hand) => {
        renderHand(hand);
        console.log('received deal', hand);
    });
    
    socket.on('gameStarted', ({currentPlayerId, players}) => {
        updateCurrentPlayer(currentPlayerId);
    });

    socket.on('turnChanged', ({ currentPlayerId }) => {
        updateCurrentPlayer(currentPlayerId);
    });

    socket.on('cardPlacedOnTable', (card) => {
      addCardToTable(card, null, 'Top of Discard Pile');
    });

    socket.on('cardPlayed', ({ playerId, playerName, card }) => {
        addCardToTable(card, playerId, playerName);
        removeCardFromHand(card.id);
    });

    socket.on('invalidMove', ({ reason }) => {
        alert('Invalid move: ' + reason);
    });

      // only the player who receives this should be prompted (server sends to one socket)
        socket.on('requestStartColor', ({ gameId: gid, card }) => {
        const allowed = ['red', 'blue', 'green', 'yellow'];
        let chosen = prompt('The starting card is a Wild. Choose the starting color: red, blue, green, yellow');
        chosen = chosen ? chosen.toLowerCase() : 'red';
        if (!allowed.includes(chosen)) chosen = 'red';
        socket.emit('startColorChosen', { gameId: gid || 'default', color: chosen });
    });

    function renderHand(hand) {
      const container = document.getElementById('hand');
      container.innerHTML = '';
      hand.forEach(card => {
        const img = document.createElement('img');
        img.src = card.img;
        img.alt = card.name || card.value;
        img.dataset.cardId = card.id;
        img.title = `${card.name} (value ${card.value})`;
        img.addEventListener('click', () => {
          // play the card
          if (card.color === 'wild') {
            const chosen = prompt('Choose a color: red, blue, green, yellow');
            const allowed = ['red', 'blue', 'green', 'yellow'];
            const chosenColor = (chosen && allowed.includes(chosen.toLowerCase())) ? chosen.toLowerCase() : 'red';
            socket.emit('playCard', { gameId: 'default', cardId: card.id, chosenColor });
          } else {
            socket.emit('playCard', { gameId: 'default', cardId: card.id });
          }
        });
        container.appendChild(img);
      });
    }

    function addCardToTable(card, playerId, playerName) {
      const table = document.getElementById('table');
      //clear other cards only show top
      table.innerHTML = '';

      const wrapper = document.createElement('div');
      wrapper.style.display = 'inline-block';
      wrapper.style.textAlign = 'center';
      wrapper.style.margin = '8px';

      const displayName = playerName || (document.getElementById('p_' + playerId)?.textContent) || playerId;
      const who = document.createElement('div');
      who.innerText = displayName;
      who.style.marginBottom = '4px';
      wrapper.appendChild(who);

      const img = document.createElement('img');
      img.src = card.img;
      img.alt = card.name || card.value;
      img.style.width = '120px';
      wrapper.appendChild(img);

      const active = card.activeColor || card.chosenColor;
      if (active) {
        const badge = document.createElement('div');
        badge.innerText = `Color: ${active}`;
        badge.style.marginTop = '6px';
        badge.style.fontWeight = '600';
        wrapper.appendChild(badge);
      }

      table.appendChild(wrapper);
    }

    function removeCardFromHand(cardId) {
      const imgs = document.querySelectorAll('#hand img');
      imgs.forEach(img => {
        if (img.dataset.cardId === cardId) img.remove();
      });
    }

     function updateCurrentPlayer(currentId, playerName) {
      const status = document.getElementById('status');
      const displayName = playerName || (document.getElementById('p_' + currentId)?.textContent) || currentId;
      status.innerText = `Current turn: ${displayName || currentId}`;
      // Highlight the player's name in playerList here
    }

    // For testing: a button to start the game (only visible to the first player normally)
    const startBtn = document.createElement('button');
    startBtn.innerText = 'Start Game';
    startBtn.addEventListener('click', () => socket.emit('startGame', { gameId: 'default', handSize: 7 }));
    document.body.appendChild(startBtn);

    // ...existing code in <script>...

// Create draw pile UI (card back image + count)
const drawContainer = document.createElement('div');
drawContainer.id = 'drawPile';
drawContainer.style.display = 'inline-block';
drawContainer.style.textAlign = 'center';
drawContainer.style.margin = '8px';

// draw pile image
const drawImg = document.createElement('img');
drawImg.id = 'drawPileImg';
drawImg.src = '/img/cards/card_Back.png';
drawImg.alt = 'Draw Pile';
drawImg.style.width = '120px';
drawImg.style.cursor = 'pointer';
drawContainer.appendChild(drawImg);

// count badge
const drawCount = document.createElement('div');
drawCount.id = 'drawCount';
drawCount.style.marginTop = '6px';
drawCount.style.fontWeight = '600';
drawCount.innerText = ''; 
drawContainer.appendChild(drawCount);

// Place the draw pile near the table
const tableEl = document.getElementById('table');
tableEl.parentNode.insertBefore(drawContainer, tableEl);

// Clicking the draw pile
drawImg.addEventListener('click', () => {
  socket.emit('drawCard', { gameId: 'default' });
});

// Update draw pile count when server tells us
socket.on('drawPileCount', ({ count }) => {
  const el = document.getElementById('drawCount');
  el.innerText = `Deck: ${count}`;
});

// Optionally show a notification when any player draws
socket.on('playerDrew', ({ playerId, count }) => {
  const name = document.getElementById('p_' + playerId)?.textContent || playerId;
  const s = document.getElementById('status');
  s.innerText = `${name} drew ${count} card${count !== 1 ? 's' : ''}`;
});
</script>
</html>
